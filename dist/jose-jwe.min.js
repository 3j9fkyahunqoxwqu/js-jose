!function(){JoseJWE=function(){this.setKeyEncryptionAlgorithm("RSA-OAEP"),this.setContentEncryptionAlgorithm("A256GCM")},JoseJWE.assert=function(a,b){if(!a)throw new Error(b)},JoseJWE.prototype.setKeyEncryptionAlgorithm=function(b){this.key_encryption=a(b)},JoseJWE.prototype.setContentEncryptionAlgorithm=function(b){this.content_encryption=a(b)};var a=function(a){switch(a){case"RSA-OAEP":return{jwe_name:"RSA-OAEP",id:{name:"RSA-OAEP",hash:{name:"SHA-1"}}};case"RSA-OAEP-256":return{jwe_name:"RSA-OAEP-256",id:{name:"RSA-OAEP",hash:{name:"SHA-256"}}};case"A128KW":return{jwe_name:"A128KW",id:{name:"AES-KW",length:128}};case"A256KW":return{jwe_name:"A256KW",id:{name:"AES-KW",length:256}};case"A128CBC-HS256":return{jwe_name:"A128CBC-HS256",id:{name:"AES-CBC",length:128},iv_bytes:16,specific_cek_bytes:32,auth:{key_bytes:16,id:{name:"HMAC",hash:{name:"SHA-256"}},truncated_bytes:16}};case"A256CBC-HS512":return{jwe_name:"A256CBC-HS512",id:{name:"AES-CBC",length:256},iv_bytes:16,specific_cek_bytes:64,auth:{key_bytes:32,id:{name:"HMAC",hash:{name:"SHA-512"}},truncated_bytes:32}};case"A128GCM":return{jwe_name:"A128GCM",id:{name:"AES-GCM",length:128},iv_bytes:12,auth:{aead:!0,tag_bytes:16}};case"A256GCM":return{jwe_name:"A256GCM",id:{name:"AES-GCM",length:256},iv_bytes:12,auth:{aead:!0,tag_bytes:16}};default:JoseJWE.assert(!1,"unsupported algorithm: "+a)}};JoseJWE.Utils={};var b={};JoseJWE.Utils.importRsaPublicKey=function(c){var d=b.convertRsaKey(c,["n","e"]),e=a("RSA-OAEP");return crypto.subtle.importKey("jwk",d,e.id,!1,["wrapKey"])},JoseJWE.Utils.importRsaPrivateKey=function(c){var d=b.convertRsaKey(c,["n","e","d","p","q","dp","dq","qi"]),e=a("RSA-OAEP");return crypto.subtle.importKey("jwk",d,e.id,!1,["unwrapKey"])},b.isString=function(a){return"string"==typeof a||a instanceof String},b.arrayish=function(a){return a instanceof Array?a:a instanceof Uint8Array?a:a instanceof ArrayBuffer?new Uint8Array(a):void JoseJWE.assert(!1,"arrayish: invalid input")},b.convertRsaKey=function(a,c){var d={},e=[];c.map(function(b){void 0===a[b]&&e.push(b)}),e.length>0&&JoseJWE.assert(!1,"convertRsaKey: Was expecting "+e.join()),void 0!==a.kty&&JoseJWE.assert("RSA"==a.kty,"convertRsaKey: expecting rsa_key['kty'] to be 'RSA'"),d.kty="RSA",void 0!==a.alg&&JoseJWE.assert("RSA-OAEP"==a.alg,"convertRsaKey: expecting rsa_key['alg'] to be 'RSA-OAEP'"),d.alg="RSA-OAEP";for(var f=function(a){return parseInt(a,16)},g=0;g<c.length;g++){var h=c[g],i=a[h];if("e"==h)"number"==typeof i&&(i=b.Base64Url.encodeArray(b.stripLeadingZeros(b.arrayFromInt32(i))));else if(/^([0-9a-fA-F]{2}:)+[0-9a-fA-F]{2}$/.test(i)){var j=i.split(":").map(f);i=b.Base64Url.encodeArray(b.stripLeadingZeros(j))}else"string"!=typeof i&&JoseJWE.assert(!1,"convertRsaKey: expecting rsa_key['"+h+"'] to be a string");d[h]=i}return d},b.arrayFromString=function(a){JoseJWE.assert(b.isString(a),"arrayFromString: invalid input");var c=a.split("").map(function(a){return a.charCodeAt(0)});return new Uint8Array(c)},b.stringFromArray=function(a){JoseJWE.assert(a instanceof ArrayBuffer,"stringFromArray: invalid input"),a=new Uint8Array(a),r="";for(var b=0;b<a.length;b++)r+=String.fromCharCode(a[b]);return r},b.stripLeadingZeros=function(a){a instanceof ArrayBuffer&&(a=new Uint8Array(a));for(var b=!0,c=[],d=0;d<a.length;d++)b&&0===a[d]||(b=!1,c.push(a[d]));return c},b.arrayFromInt32=function(a){JoseJWE.assert("number"==typeof a,"arrayFromInt32: invalid input"),JoseJWE.assert(a==a|0,"arrayFromInt32: out of range");for(var b=new Uint8Array(new Uint32Array([a]).buffer),c=new Uint8Array(4),d=0;4>d;d++)c[d]=b[3-d];return c.buffer},b.arrayBufferConcat=function(){for(var a=[],c=0,d=0;d<arguments.length;d++)a.push(b.arrayish(arguments[d])),c+=a[d].length;var e=new Uint8Array(c),f=0;for(d=0;d<arguments.length;d++)for(var g=0;g<a[d].length;g++)e[f++]=a[d][g];return JoseJWE.assert(f==c,"arrayBufferConcat: unexpected offset"),e},b.compare=function(a,b,c,d){return JoseJWE.assert(c instanceof Uint8Array,"compare: invalid input"),JoseJWE.assert(d instanceof Uint8Array,"compare: invalid input"),b.then(function(b){var e=crypto.subtle.sign(a.auth.id,b,c),f=crypto.subtle.sign(a.auth.id,b,d);return Promise.all([e,f]).then(function(a){var b=new Uint8Array(a[0]),c=new Uint8Array(a[1]);if(b.length!=c.length)throw new Error("compare failed");for(var d=0;d<b.length;d++)if(b[d]!=c[d])throw new Error("compare failed");return Promise.accept(null)})})},b.getCekWorkaround=function(a){var b=a.specific_cek_bytes;if(b){if(16==b)return{id:{name:"AES-CBC",length:128},enc_op:["encrypt"],dec_op:["decrypt"]};if(32==b)return{id:{name:"AES-CBC",length:256},enc_op:["encrypt"],dec_op:["decrypt"]};if(64==b)return{id:{name:"HMAC",hash:{name:"SHA-256"}},enc_op:["sign"],dec_op:["verify"]};if(128==b)return{id:{name:"HMAC",hash:{name:"SHA-384"}},enc_op:["sign"],dec_op:["verify"]};JoseJWE.assert(!1,"getCekWorkaround: invalid len")}return{id:a.id,enc_op:["encrypt"],dec_op:["decrypt"]}},b.Base64Url={},b.Base64Url.encode=function(a){return JoseJWE.assert(b.isString(a),"Base64Url.encode: invalid input"),btoa(a).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")},b.Base64Url.encodeArray=function(a){a=b.arrayish(a);var c="";for(i=0;i<a.length;i++)c+=String.fromCharCode(a[i]);return b.Base64Url.encode(c)},b.Base64Url.decode=function(a){return JoseJWE.assert(b.isString(a),"Base64Url.decode: invalid input"),atob(a.replace(/-/g,"+").replace(/_/g,"/"))},b.Base64Url.decodeArray=function(a){return JoseJWE.assert(b.isString(a),"Base64Url.decodeArray: invalid input"),b.arrayFromString(b.Base64Url.decode(a))},JoseJWE.prototype.createIV=function(){var a=new Uint8Array(new Array(this.content_encryption.iv_bytes));return crypto.getRandomValues(a)},JoseJWE.prototype.createCEK=function(){var a=b.getCekWorkaround(this.content_encryption);return crypto.subtle.generateKey(a.id,!0,a.enc_op)},JoseJWE.prototype.encrypt=function(a,c){var d=this.createCEK(),e=this.encryptCek(a,d),f=this.encryptPlainText(d,c);return Promise.all([e,f]).then(function(a){var c=a[0],d=a[1];return d.header+"."+b.Base64Url.encodeArray(c)+"."+b.Base64Url.encodeArray(d.iv)+"."+b.Base64Url.encodeArray(d.cipher)+"."+b.Base64Url.encodeArray(d.tag)})},JoseJWE.prototype.encryptCek=function(a,b){var c=this.key_encryption;return Promise.all([a,b]).then(function(a){var b=a[0],d=a[1];return crypto.subtle.wrapKey("raw",d,b,c.id)})},JoseJWE.prototype.encryptPlainText=function(a,d){var e=b.Base64Url.encode(JSON.stringify({alg:this.key_encryption.jwe_name,enc:this.content_encryption.jwe_name})),f=this.createIV();if(f.length!=this.content_encryption.iv_bytes)return Promise.reject("encryptPlainText: invalid IV length");var g=b.arrayFromString(e);d=b.arrayFromString(d);var h=this.content_encryption;if(h.auth.aead){var i=h.auth.tag_bytes,j={name:h.id.name,iv:f,additionalData:g,tagLength:8*i};return a.then(function(a){return crypto.subtle.encrypt(j,a,d).then(function(a){var b=a.byteLength-i;return{header:e,iv:f,cipher:a.slice(0,b),tag:a.slice(b)}})})}var k=c.splitKey(h,a,["encrypt"]),l=k[0],m=k[1],n=m.then(function(a){var b={name:h.id.name,iv:f};return crypto.subtle.encrypt(b,a,d)}),o=n.then(function(a){return c.truncatedMac(h,l,g,f,a)});return Promise.all([n,o]).then(function(a){var b=a[0],c=a[1];return{header:e,iv:f,cipher:b,tag:c}})},JoseJWE.prototype.decrypt=function(a,c){var d=c.split(".");if(5!=d.length)return Promise.reject("decrypt: invalid input");if(header=JSON.parse(b.Base64Url.decode(d[0])),!header.alg)return Promise.reject("decrypt: missing alg");if(this.setKeyEncryptionAlgorithm(header.alg),!header.enc)return Promise.reject("decrypt: missing enc");if(this.setContentEncryptionAlgorithm(header.enc),header.crit)return Promise.reject("decrypt: crit is not supported");var e=this.decryptCek(a,b.Base64Url.decodeArray(d[1])),f=this.decryptCiphertext(e,b.arrayFromString(d[0]),b.Base64Url.decodeArray(d[2]),b.Base64Url.decodeArray(d[3]),b.Base64Url.decodeArray(d[4]));return f.then(b.stringFromArray)},JoseJWE.prototype.decryptCiphertext=function(a,d,e,f,g){if(e.length!=this.content_encryption.iv_bytes)return Promise.reject("decryptCiphertext: invalid IV");var h=this.content_encryption;if(h.auth.aead){var i={name:h.id.name,iv:e,additionalData:d,tagLength:8*h.auth.tag_bytes};return a.then(function(a){var c=b.arrayBufferConcat(f,g);return crypto.subtle.decrypt(i,a,c)})}var j=c.splitKey(h,a,["decrypt"]),k=j[0],l=j[1],m=c.truncatedMac(h,k,d,e,f);return Promise.all([l,m]).then(function(a){var c=a[0],d=a[1];return b.compare(h,k,new Uint8Array(d),g).then(function(){var a={name:h.id.name,iv:e};return crypto.subtle.decrypt(a,c,f)})["catch"](function(){return Promise.reject("decryptCiphertext: MAC failed.")})})},JoseJWE.prototype.decryptCek=function(a,c){var d=b.getCekWorkaround(this.content_encryption),e=this.content_encryption.specific_cek_bytes>0,f=this.key_encryption.id;return a.then(function(a){return crypto.subtle.unwrapKey("raw",c,a,f,d.id,e,d.dec_op)})};var c={};c.splitKey=function(a,b,c){var d=b.then(function(a){return crypto.subtle.exportKey("raw",a)}),e=d.then(function(b){if(8*b.byteLength!=a.id.length+8*a.auth.key_bytes)return Promise.reject("encryptPlainText: incorrect cek length");var c=b.slice(0,a.auth.key_bytes);return crypto.subtle.importKey("raw",c,a.auth.id,!1,["sign"])}),f=d.then(function(b){if(8*b.byteLength!=a.id.length+8*a.auth.key_bytes)return Promise.reject("encryptPlainText: incorrect cek length");var d=b.slice(a.auth.key_bytes);return crypto.subtle.importKey("raw",d,a.id,!1,c)});return[e,f]},c.truncatedMac=function(a,c,d,e,f){return c.then(function(c){var g=new Uint8Array(b.arrayFromInt32(8*d.length)),h=new Uint8Array(8);h.set(g,4);var i=b.arrayBufferConcat(d,e,f,h);return crypto.subtle.sign(a.auth.id,c,i).then(function(b){return b.slice(0,a.auth.truncated_bytes)})})}}();