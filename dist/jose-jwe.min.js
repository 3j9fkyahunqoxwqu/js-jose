function JoseJWE(){this.setKeyEncryptionAlgorithm("RSA-OAEP"),this.setContentEncryptionAlgorithm("A256GCM")}JoseJWE.assert=function(a,b){if(!a)throw new Error(b)},JoseJWE.prototype.setKeyEncryptionAlgorithm=function(a){this.key_encryption=JoseJWE.getCryptoConfig(a)},JoseJWE.prototype.setContentEncryptionAlgorithm=function(a){this.content_encryption=JoseJWE.getCryptoConfig(a)},JoseJWE.getCryptoConfig=function(a){switch(a){case"RSA-OAEP":return{jwe_name:"RSA-OAEP",id:{name:"RSA-OAEP",hash:{name:"SHA-1"}}};case"RSA-OAEP-256":return{jwe_name:"RSA-OAEP-256",id:{name:"RSA-OAEP",hash:{name:"SHA-256"}}};case"A128KW":return{jwe_name:"A128KW",id:{name:"AES-KW",length:128}};case"A256KW":return{jwe_name:"A256KW",id:{name:"AES-KW",length:256}};case"A128CBC-HS256":return{jwe_name:"A128CBC-HS256",id:{name:"AES-CBC",length:128},iv_bytes:16,specific_cek_bytes:32,auth:{key_bytes:16,id:{name:"HMAC",hash:{name:"SHA-256"}},truncated_bytes:16}};case"A256CBC-HS512":return{id:{name:"AES-CBC",length:256},iv_bytes:16,specific_cek_bytes:64,auth:{key_bytes:32,id:{name:"HMAC",hash:{name:"SHA-512"}},truncated_bytes:32}};case"A128GCM":return{id:{name:"AES-GCM",length:128},iv_bytes:12,auth:{aead:!0,tag_bytes:16}};case"A256GCM":return{jwe_name:"A256GCM",id:{name:"AES-GCM",length:256},iv_bytes:12,auth:{aead:!0,tag_bytes:16}};default:JoseJWE.assert(!1,"unsupported algorithm: "+a)}},JoseJWE.Utils={},JoseJWE.Utils.isString=function(a){return"string"==typeof a||a instanceof String},JoseJWE.Utils.importRsaKeyFromHex=function(a,b){if(!JoseJWE.Utils.isString(a.n))return Promise.reject("importRsaKeyFromHex: expecting rsa_key['n'] to be a string");if("number"!=typeof a.e)return Promise.reject("importRsaKeyFromHex: expecting rsa_key['e'] to be a number");if(!(b instanceof Array))return Promise.reject("importRsaKeyFromHex: expecting purpose to be an array");b.push("wrapKey");var c=a.n.split(":").map(function(a){return String.fromCharCode(parseInt(a,16))}).join(""),d={kty:"RSA",n:JoseJWE.Utils.Base64Url.encode(c),e:JoseJWE.Utils.Base64Url.encodeArrayBuffer(JoseJWE.Utils.arrayFromInt32(a.e))},e=JoseJWE.getCryptoConfig("RSA-OAEP");return crypto.subtle.importKey("jwk",d,e.id,!1,b)},JoseJWE.Utils.importRSAfromJWK=function(a,b){if(!JoseJWE.Utils.isString(a.kty))return Promise.reject("importRSAfromJWK: expecting jwk['kty'] to be a string");if("RSA"!=a.kty)return Promise.reject("importRSAfromJWK: expecting jwk['kty'] to be RSA");if(!JoseJWE.Utils.isString(a.n))return Promise.reject("importRSAfromJWK: expecting jwk['n'] to be a string");if(!JoseJWE.Utils.isString(a.e))return Promise.reject("importRSAfromJWK: expecting jwk['e'] to be a string");if(!(b instanceof Array))return Promise.reject("importRSAfromJWK: expecting purpose to be an array");b.push("wrapKey");var c=JoseJWE.getCryptoConfig("RSA-OAEP");return crypto.subtle.importKey("jwk",a,c.id,!1,b)},JoseJWE.Utils.arrayFromString=function(a){var b=a.split("").map(function(a){return a.charCodeAt(0)});return new Uint8Array(b)},JoseJWE.Utils.arrayFromInt32=function(a){return JoseJWE.assert("number"==typeof a),JoseJWE.assert(a==a|0,"arrayFromInt32: out of range"),new Uint32Array([a]).buffer},JoseJWE.Utils.arrayBufferConcat=function(){for(var a=0,b=0;b<arguments.length;b++)JoseJWE.assert(arguments[b]instanceof ArrayBuffer,"arrayBufferConcat: unexpecting input"),a+=arguments[b].byteLength;var c=new Uint8Array(a),d=0;for(b=0;b<arguments.length;b++)c.set(new Uint8Array(arguments[b]),d),d+=arguments[b].byteLength;return JoseJWE.assert(d==a,"arrayBufferConcat: unexpected offset"),c},JoseJWE.Utils.Base64Url={},JoseJWE.Utils.Base64Url.encode=function(a){return JoseJWE.assert(JoseJWE.Utils.isString(a)),btoa(a).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")},JoseJWE.Utils.Base64Url.encodeArrayBuffer=function(a){JoseJWE.assert(a instanceof ArrayBuffer,"encodeArrayBuffer: invalid input"),arr=new Uint8Array(a);var b="";for(i=0;i<arr.length;i++)b+=String.fromCharCode(arr[i]);return JoseJWE.Utils.Base64Url.encode(b)},JoseJWE.prototype.createIV=function(){var a=new Uint8Array(new Array(this.content_encryption.iv_bytes));return crypto.getRandomValues(a)},JoseJWE.prototype.createCEK=function(){var a=this.content_encryption.specific_cek_bytes;if(a){if(16==a)return crypto.subtle.generateKey({name:"AES-CBC",length:128},!0,["encrypt"]);if(32==a)return crypto.subtle.generateKey({name:"AES-CBC",length:256},!0,["encrypt"]);if(64==a)return crypto.subtle.generateKey({name:"HMAC",hash:{name:"SHA-256"}},!0,["sign"]);if(128==a)return crypto.subtle.generateKey({name:"HMAC",hash:{name:"SHA-384"}},!0,["sign"]);JoseJWE.assert(!1,"createCEK: invalid specific_cek_bytes")}return crypto.subtle.generateKey(this.content_encryption.id,!0,["encrypt"])},JoseJWE.prototype.encrypt=function(a,b){var c=this.createCEK(),d=this.encryptCek(a,c),e=this.encryptPlaintext(c,b);return Promise.all([d,e]).then(function(a){var b=a[0],c=a[1];return c.header+"."+JoseJWE.Utils.Base64Url.encodeArrayBuffer(b)+"."+JoseJWE.Utils.Base64Url.encodeArrayBuffer(c.iv.buffer)+"."+JoseJWE.Utils.Base64Url.encodeArrayBuffer(c.cipher)+"."+JoseJWE.Utils.Base64Url.encodeArrayBuffer(c.tag)})},JoseJWE.prototype.encryptCek=function(a,b){var c=this.key_encryption;return Promise.all([a,b]).then(function(a){var b=a[0],d=a[1];return crypto.subtle.wrapKey("raw",d,b,c.id)})},JoseJWE.prototype.encryptPlaintext=function(a,b){var c=JoseJWE.Utils.Base64Url.encode(JSON.stringify({alg:this.key_encryption.jwe_name,enc:this.content_encryption.jwe_name})),d=this.createIV();if(d.length!=this.content_encryption.iv_bytes)return Promise.reject("encryptPlaintext: invalid IV length");var e=JoseJWE.Utils.arrayFromString(c);b=JoseJWE.Utils.arrayFromString(b);var f=this.content_encryption;if(f.auth.aead){var g=f.auth.tag_bytes,h={name:f.id.name,iv:d,additionalData:e,tagLength:8*g};return a.then(function(a){return crypto.subtle.encrypt(h,a,b).then(function(a){var b=a.byteLength-g;return{header:c,iv:d,cipher:a.slice(0,b),tag:a.slice(b)}})})}var i=a.then(function(a){return crypto.subtle.exportKey("raw",a)}),j=i.then(function(a){if(8*a.byteLength!=f.id.length+8*f.auth.key_bytes)return Promise.reject("encryptPlaintext: incorrect cek length");var b=a.slice(0,f.auth.key_bytes);return crypto.subtle.importKey("raw",b,f.auth.id,!1,["sign"])}),k=i.then(function(a){if(8*a.byteLength!=f.id.length+8*f.auth.key_bytes)return Promise.reject("encryptPlaintext: incorrect cek length");var b=a.slice(f.auth.key_bytes);return crypto.subtle.importKey("raw",b,f.id,!1,["encrypt"])}),l=k.then(function(a){var c={name:f.id.name,iv:d};return crypto.subtle.encrypt(c,a,b)}),m=Promise.all([j,l]).then(function(a){for(var b=a[0],c=a[1],g=new Uint8Array(JoseJWE.Utils.arrayFromInt32(8*e.length)),h=new Uint8Array(8),i=0;4>i;i++)h[7-i]=g[i];var j=JoseJWE.Utils.arrayBufferConcat(e.buffer,d.buffer,c,h.buffer);return crypto.subtle.sign(f.auth.id,b,j)});return Promise.all([l,m]).then(function(a){var b=a[0],e=a[1];return{header:c,iv:d,cipher:b,tag:e.slice(0,f.auth.truncated_bytes)}})};