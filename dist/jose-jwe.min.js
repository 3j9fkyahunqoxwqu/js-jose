function JoseJWE(){this.setKeyEncryptionAlgorithm("RSA-OAEP"),this.setContentEncryptionAlgorithm("A256GCM")}JoseJWE.assert=function(a,b){if(!a)throw new Error(b)},JoseJWE.prototype.setKeyEncryptionAlgorithm=function(a){this.key_encryption=JoseJWE.getCryptoConfig(a)},JoseJWE.prototype.setContentEncryptionAlgorithm=function(a){this.content_encryption=JoseJWE.getCryptoConfig(a)},JoseJWE.getCryptoConfig=function(a){switch(a){case"RSA-OAEP":return{jwe_name:"RSA-OAEP",id:{name:"RSA-OAEP",hash:{name:"SHA-1"}}};case"RSA-OAEP-256":return{jwe_name:"RSA-OAEP-256",id:{name:"RSA-OAEP",hash:{name:"SHA-256"}}};case"A128KW":return{jwe_name:"A128KW",id:{name:"AES-KW",length:128}};case"A256KW":return{jwe_name:"A256KW",id:{name:"AES-KW",length:256}};case"A128CBC-HS256":return{jwe_name:"A128CBC-HS256",id:{name:"AES-CBC",length:128},iv_bytes:16,specific_cek_bytes:32,auth:{key_bytes:16,id:{name:"HMAC",hash:{name:"SHA-256"}},truncated_bytes:16}};case"A256CBC-HS512":return{id:{name:"AES-CBC",length:256},iv_bytes:16,specific_cek_bytes:64,auth:{key_bytes:32,id:{name:"HMAC",hash:{name:"SHA-512"}},truncated_bytes:32}};case"A128GCM":return{id:{name:"AES-GCM",length:128},iv_bytes:12,auth:{aead:!0,tag_bytes:16}};case"A256GCM":return{jwe_name:"A256GCM",id:{name:"AES-GCM",length:256},iv_bytes:12,auth:{aead:!0,tag_bytes:16}};default:JoseJWE.assert(!1,"unsupported algorithm: "+a)}},JoseJWE.Utils={},JoseJWE.Utils.isString=function(a){return"string"==typeof a||a instanceof String},JoseJWE.Utils.arrayish=function(a){return a instanceof Array?a:a instanceof Uint8Array?a:a instanceof ArrayBuffer?new Uint8Array(a):void JoseJWE.assert(!1,"arrayish: invalid input")},JoseJWE.Utils.importRsaPublicKey=function(a){var b=JoseJWE.Utils.convertRsaKey(a,["n","e"]),c=JoseJWE.getCryptoConfig("RSA-OAEP");return crypto.subtle.importKey("jwk",b,c.id,!1,["wrapKey"])},JoseJWE.Utils.importRsaPrivateKey=function(a){var b=JoseJWE.Utils.convertRsaKey(a,["n","e","d","p","q","dp","dq","qi"]),c=JoseJWE.getCryptoConfig("RSA-OAEP");return crypto.subtle.importKey("jwk",b,c.id,!1,["unwrapKey"])},JoseJWE.Utils.convertRsaKey=function(a,b){var c={},d=[];b.map(function(b){void 0===a[b]&&d.push(b)}),d.length>0&&JoseJWE.assert(!1,"convertRsaKey: Was expecting "+d.join()),void 0!==a.kty&&JoseJWE.assert("RSA"==a.kty,"convertRsaKey: expecting rsa_key['kty'] to be 'RSA'"),c.kty="RSA",void 0!==a.alg&&JoseJWE.assert("RSA-OAEP"==a.alg,"convertRsaKey: expecting rsa_key['alg'] to be 'RSA-OAEP'"),c.alg="RSA-OAEP";for(var e=function(a){return parseInt(a,16)},f=0;f<b.length;f++){var g=b[f],h=a[g];if("e"==g)"number"==typeof h&&(h=JoseJWE.Utils.Base64Url.encodeArray(JoseJWE.Utils.stripLeadingZeros(JoseJWE.Utils.arrayFromInt32(h))));else if(/^([0-9a-fA-F]{2}:)+[0-9a-fA-F]{2}$/.test(h)){var i=h.split(":").map(e);h=JoseJWE.Utils.Base64Url.encodeArray(JoseJWE.Utils.stripLeadingZeros(i))}else"string"!=typeof h&&JoseJWE.assert(!1,"convertRsaKey: expecting rsa_key['"+g+"'] to be a string");c[g]=h}return c},JoseJWE.Utils.arrayFromString=function(a){JoseJWE.assert(JoseJWE.Utils.isString(a),"arrayFromString: invalid input");var b=a.split("").map(function(a){return a.charCodeAt(0)});return new Uint8Array(b)},JoseJWE.Utils.stringFromArray=function(a){JoseJWE.assert(a instanceof ArrayBuffer,"stringFromArray: invalid input"),a=new Uint8Array(a),r="";for(var b=0;b<a.length;b++)r+=String.fromCharCode(a[b]);return r},JoseJWE.Utils.stripLeadingZeros=function(a){a instanceof ArrayBuffer&&(a=new Uint8Array(a));for(var b=!0,c=[],d=0;d<a.length;d++)b&&0===a[d]||(b=!1,c.push(a[d]));return c},JoseJWE.Utils.arrayFromInt32=function(a){JoseJWE.assert("number"==typeof a,"arrayFromInt32: invalid input"),JoseJWE.assert(a==a|0,"arrayFromInt32: out of range");for(var b=new Uint8Array(new Uint32Array([a]).buffer),c=new Uint8Array(4),d=0;4>d;d++)c[d]=b[3-d];return c.buffer},JoseJWE.Utils.arrayBufferConcat=function(){for(var a=[],b=0,c=0;c<arguments.length;c++)a.push(JoseJWE.Utils.arrayish(arguments[c])),b+=a[c].length;var d=new Uint8Array(b),e=0;for(c=0;c<arguments.length;c++)for(var f=0;f<a[c].length;f++)d[e++]=a[c][f];return JoseJWE.assert(e==b,"arrayBufferConcat: unexpected offset"),d},JoseJWE.Utils.compare=function(a,b){if(JoseJWE.assert(a instanceof Uint8Array,"compare: invalid input"),JoseJWE.assert(b instanceof Uint8Array,"compare: invalid input"),a.length!=b.length)return!1;ok=0;for(var c=0;c<a.length;c++)ok|=a[c]^b[c];return 0===ok},JoseJWE.Utils.getCekWorkaround=function(a){var b=a.specific_cek_bytes;if(b){if(16==b)return{id:{name:"AES-CBC",length:128},enc_op:["encrypt"],dec_op:["decrypt"]};if(32==b)return{id:{name:"AES-CBC",length:256},enc_op:["encrypt"],dec_op:["decrypt"]};if(64==b)return{id:{name:"HMAC",hash:{name:"SHA-256"}},enc_op:["sign"],dec_op:["verify"]};if(128==b)return{id:{name:"HMAC",hash:{name:"SHA-384"}},enc_op:["sign"],dec_op:["verify"]};JoseJWE.assert(!1,"getCekWorkaround: invalid len")}return{id:a.id,enc_op:["encrypt"],dec_op:["decrypt"]}},JoseJWE.Utils.Base64Url={},JoseJWE.Utils.Base64Url.encode=function(a){return JoseJWE.assert(JoseJWE.Utils.isString(a),"Base64Url.encode: invalid input"),btoa(a).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")},JoseJWE.Utils.Base64Url.encodeArray=function(a){a=JoseJWE.Utils.arrayish(a);var b="";for(i=0;i<a.length;i++)b+=String.fromCharCode(a[i]);return JoseJWE.Utils.Base64Url.encode(b)},JoseJWE.Utils.Base64Url.decode=function(a){return JoseJWE.assert(JoseJWE.Utils.isString(a),"Base64Url.decode: invalid input"),atob(a.replace(/-/g,"+").replace(/_/g,"/"))},JoseJWE.Utils.Base64Url.decodeArray=function(a){return JoseJWE.assert(JoseJWE.Utils.isString(a),"Base64Url.decodeArray: invalid input"),JoseJWE.Utils.arrayFromString(JoseJWE.Utils.Base64Url.decode(a))},JoseJWE.prototype.createIV=function(){var a=new Uint8Array(new Array(this.content_encryption.iv_bytes));return crypto.getRandomValues(a)},JoseJWE.prototype.createCEK=function(){var a=JoseJWE.Utils.getCekWorkaround(this.content_encryption);return crypto.subtle.generateKey(a.id,!0,a.enc_op)},JoseJWE.prototype.encrypt=function(a,b){var c=this.createCEK(),d=this.encryptCek(a,c),e=this.encryptPlainText(c,b);return Promise.all([d,e]).then(function(a){var b=a[0],c=a[1];return c.header+"."+JoseJWE.Utils.Base64Url.encodeArray(b)+"."+JoseJWE.Utils.Base64Url.encodeArray(c.iv)+"."+JoseJWE.Utils.Base64Url.encodeArray(c.cipher)+"."+JoseJWE.Utils.Base64Url.encodeArray(c.tag)})},JoseJWE.prototype.encryptCek=function(a,b){var c=this.key_encryption;return Promise.all([a,b]).then(function(a){var b=a[0],d=a[1];return crypto.subtle.wrapKey("raw",d,b,c.id)})},JoseJWE.prototype.encryptPlainText=function(a,b){var c=JoseJWE.Utils.Base64Url.encode(JSON.stringify({alg:this.key_encryption.jwe_name,enc:this.content_encryption.jwe_name})),d=this.createIV();if(d.length!=this.content_encryption.iv_bytes)return Promise.reject("encryptPlainText: invalid IV length");var e=JoseJWE.Utils.arrayFromString(c);b=JoseJWE.Utils.arrayFromString(b);var f=this.content_encryption;if(f.auth.aead){var g=f.auth.tag_bytes,h={name:f.id.name,iv:d,additionalData:e,tagLength:8*g};return a.then(function(a){return crypto.subtle.encrypt(h,a,b).then(function(a){var b=a.byteLength-g;return{header:c,iv:d,cipher:a.slice(0,b),tag:a.slice(b)}})})}var i=a.then(function(a){return crypto.subtle.exportKey("raw",a)}),j=i.then(function(a){if(8*a.byteLength!=f.id.length+8*f.auth.key_bytes)return Promise.reject("encryptPlainText: incorrect cek length");var b=a.slice(0,f.auth.key_bytes);return crypto.subtle.importKey("raw",b,f.auth.id,!1,["sign"])}),k=i.then(function(a){if(8*a.byteLength!=f.id.length+8*f.auth.key_bytes)return Promise.reject("encryptPlainText: incorrect cek length");var b=a.slice(f.auth.key_bytes);return crypto.subtle.importKey("raw",b,f.id,!1,["encrypt"])}),l=k.then(function(a){var c={name:f.id.name,iv:d};return crypto.subtle.encrypt(c,a,b)}),m=Promise.all([j,l]).then(function(a){var b=a[0],c=a[1],g=new Uint8Array(JoseJWE.Utils.arrayFromInt32(8*e.length)),h=new Uint8Array(8);h.set(g,4);var i=JoseJWE.Utils.arrayBufferConcat(e,d,c,h);return crypto.subtle.sign(f.auth.id,b,i)});return Promise.all([l,m]).then(function(a){var b=a[0],e=a[1];return{header:c,iv:d,cipher:b,tag:e.slice(0,f.auth.truncated_bytes)}})},JoseJWE.prototype.decrypt=function(a,b){var c=b.split(".");if(5!=c.length)return Promise.reject("decrypt: invalid input");if(header=JSON.parse(JoseJWE.Utils.Base64Url.decode(c[0])),!header.alg)return Promise.reject("decrypt: missing alg");if(this.setKeyEncryptionAlgorithm(header.alg),!header.enc)return Promise.reject("decrypt: missing enc");if(this.setContentEncryptionAlgorithm(header.enc),header.crit)return Promise.reject("decrypt: crit is not supported");var d=this.decryptCek(a,JoseJWE.Utils.Base64Url.decodeArray(c[1])),e=this.decryptCiphertext(d,JoseJWE.Utils.arrayFromString(c[0]),JoseJWE.Utils.Base64Url.decodeArray(c[2]),JoseJWE.Utils.Base64Url.decodeArray(c[3]),JoseJWE.Utils.Base64Url.decodeArray(c[4]));return e.then(JoseJWE.Utils.stringFromArray)},JoseJWE.prototype.decryptCiphertext=function(a,b,c,d,e){if(c.length!=this.content_encryption.iv_bytes)return Promise.reject("decryptCiphertext: invalid IV");var f=this.content_encryption;if(f.auth.aead){var g={name:f.id.name,iv:c,additionalData:b,tagLength:8*f.auth.tag_bytes};return a.then(function(a){var b=JoseJWE.Utils.arrayBufferConcat(d,e);return crypto.subtle.decrypt(g,a,b)})}var h=a.then(function(a){return crypto.subtle.exportKey("raw",a)}),i=h.then(function(a){if(8*a.byteLength!=f.id.length+8*f.auth.key_bytes)return Promise.reject("decryptCiphertext: incorrect cek length");var b=a.slice(0,f.auth.key_bytes);return crypto.subtle.importKey("raw",b,f.auth.id,!1,["sign"])}),j=h.then(function(a){if(8*a.byteLength!=f.id.length+8*f.auth.key_bytes)return Promise.reject("decryptCiphertext: incorrect cek length");var b=a.slice(f.auth.key_bytes);return crypto.subtle.importKey("raw",b,f.id,!1,["decrypt"])}),k=i.then(function(a){var g=new Uint8Array(JoseJWE.Utils.arrayFromInt32(8*b.length)),h=new Uint8Array(8);h.set(g,4);var i=JoseJWE.Utils.arrayBufferConcat(b,c,d,h);return crypto.subtle.sign(f.auth.id,a,i).then(function(a){return a=a.slice(0,f.auth.truncated_bytes),JoseJWE.Utils.compare(new Uint8Array(a),e)?Promise.resolve():Promise.reject("decryptCiphertext: MAC failed.")})});return Promise.all([j,k]).then(function(a){var b=a[0],e={name:f.id.name,iv:c};return crypto.subtle.decrypt(e,b,d)})},JoseJWE.prototype.decryptCek=function(a,b){var c=JoseJWE.Utils.getCekWorkaround(this.content_encryption),d=this.content_encryption.specific_cek_bytes>0,e=this.key_encryption.id;return a.then(function(a){return crypto.subtle.unwrapKey("raw",b,a,e,c.id,d,c.dec_op).catch(function(){return crypto.subtle.generateKey(c.id,!1,c.dec_op)})})};